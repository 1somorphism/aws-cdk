"use strict";var I=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var Q=(t,e)=>{for(var r in e)I(t,r,{get:e[r],enumerable:!0})},_=(t,e,r,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of z(e))!J.call(t,a)&&a!==r&&I(t,a,{get:()=>e[a],enumerable:!(s=X(e,a))||s.enumerable});return t};var ee=t=>_(I({},"__esModule",{value:!0}),t);var ue={};Q(ue,{handler:()=>ce});module.exports=ee(ue);var x=require("@aws-sdk/client-redshift-data"),q=new x.RedshiftData({});async function l(t,e){let r={ClusterIdentifier:e.clusterName,Database:e.databaseName,SecretArn:e.adminUserArn,Sql:t},s=await q.executeStatement(r);if(!s.Id)throw new Error("Service error: Statement execution did not return a statement ID");await Y(s.Id)}var te=100;async function Y(t){await new Promise(r=>{setTimeout(()=>r(),te)});let e=await q.describeStatement({Id:t});if(e.Status!=="FINISHED"&&e.Status!=="FAILED"&&e.Status!=="ABORTED")return Y(t);if(e.Status==="FINISHED")return;throw new Error(`Statement status was ${e.Status}: ${e.Error}`)}function g(t,e,r){return`${e.clusterName}:${e.databaseName}:${t}:${r}`}function h(t){let e=t.filter(r=>r.distKey===!0||r.distKey==="true");if(e.length!==0){if(e.length>1)throw new Error("Multiple dist key columns found");return e[0]}}function P(t){return t.filter(e=>e.sortKey===!0||e.sortKey==="true")}function H(t,e){return t.length!==e.length?!1:t.every(r=>e.find(s=>s.name===r.name&&s.dataType===r.dataType))}async function B(t,e){let r=t.username,s=t.tablePrivileges,a=t;if(e.RequestType==="Create")return await O(r,s,a),{PhysicalResourceId:g(r,a,e.RequestId)};if(e.RequestType==="Delete"){await k(r,s,a);return}else if(e.RequestType==="Update"){let{replace:i}=await re(r,s,a,e.OldResourceProperties);return{PhysicalResourceId:i?g(r,a,e.RequestId):e.PhysicalResourceId}}else throw new Error(`Unrecognized event type: ${e.RequestType}`)}async function k(t,e,r){await Promise.all(e.map(({tableName:s,actions:a})=>l(`REVOKE ${a.join(", ")} ON ${s} FROM ${t}`,r)))}async function O(t,e,r){await Promise.all(e.map(({tableName:s,actions:a})=>l(`GRANT ${a.join(", ")} ON ${s} TO ${t}`,r)))}async function re(t,e,r,s){let a=s;if(r.clusterName!==a.clusterName||r.databaseName!==a.databaseName)return await O(t,e,r),{replace:!0};if(s.username!==t)return await O(t,e,r),{replace:!0};let m=s.tablePrivileges,o=m.filter(({tableId:u,actions:T})=>e.find(({tableId:p,actions:y})=>u===p&&T.some(E=>!y.includes(E))));o.length>0&&await k(t,o,r);let d=e.filter(({tableId:u,tableName:T,actions:p})=>{let y=!m.find(({tableId:S,tableName:f})=>u===S&&T===f),E=m.find(({tableId:S,actions:f})=>u===S&&f.some(L=>!p.includes(L)));return y||E});return d.length>0&&await O(t,d,r),{replace:!1}}async function W(t,e){let r=t.tableName.prefix,s=t.tableName.generateSuffix==="true"?`${e.RequestId.substring(0,8)}`:"",a=t.tableColumns,i=t,m=t.useColumnIds;if(e.RequestType==="Create")return{PhysicalResourceId:await A(r,s,a,i)};if(e.RequestType==="Delete"){await se(e.PhysicalResourceId,i);return}else{if(e.RequestType==="Update")return{PhysicalResourceId:await ae(e.PhysicalResourceId,r,s,a,m,i,e.OldResourceProperties)};throw new Error(`Unrecognized event type: ${e.RequestType}`)}}async function A(t,e,r,s){let a=t+e,i=r.map(u=>`${u.name} ${u.dataType}${ne(u)}`).join(),m=`CREATE TABLE ${a} (${i})`;s.distStyle&&(m+=` DISTSTYLE ${s.distStyle}`);let o=h(r);o&&(m+=` DISTKEY(${o.name})`);let d=P(r);if(d.length>0){let u=v(d);m+=` ${s.sortStyle} SORTKEY(${u})`}await l(m,s);for(let u of r)u.comment&&await l(`COMMENT ON COLUMN ${a}.${u.name} IS '${u.comment}'`,s);return s.tableComment&&await l(`COMMENT ON TABLE ${a} IS '${s.tableComment}'`,s),a}async function se(t,e){await l(`DROP TABLE ${t}`,e)}async function ae(t,e,r,s,a,i,m){let o=[],d=m;if(i.clusterName!==d.clusterName||i.databaseName!==d.databaseName)return A(e,r,s,i);let u=m.tableName.prefix;if(e!==u)return A(e,r,s,i);let T=m.tableColumns,p=T.filter(n=>s.every(c=>a&&n.id?n.id!==c.id:n.name!==c.name));p.length>0&&o.push(...p.map(n=>`ALTER TABLE ${t} DROP COLUMN ${n.name}`));let y=s.filter(n=>!T.some(c=>a&&c.id?c.id===n.id:c.name===n.name)).map(n=>`ADD ${n.name} ${n.dataType}`);y.length>0&&o.push(...y.map(n=>`ALTER TABLE ${t} ${n}`));let E=s.filter(n=>T.some(c=>n.name===c.name&&n.encoding!==c.encoding)).map(n=>`ALTER COLUMN ${n.name} ENCODE ${n.encoding||"AUTO"}`);E.length>0&&o.push(`ALTER TABLE ${t} ${E.join(", ")}`);let S=s.filter(n=>T.some(c=>n.name===c.name&&n.comment!==c.comment)).map(n=>`COMMENT ON COLUMN ${t}.${n.name} IS ${n.comment?`'${n.comment}'`:"NULL"}`);if(S.length>0&&o.push(...S),a){let n=s.reduce((c,w)=>{let U=T.find(M=>M.id&&M.id===w.id);return U&&U.name!==w.name&&(c[U.name]=w.name),c},{});Object.keys(n).length>0&&o.push(...Object.entries(n).map(([c,w])=>`ALTER TABLE ${t} RENAME COLUMN ${c} TO ${w}`))}let f=m.distStyle;if(!f&&i.distStyle||f&&!i.distStyle)return A(e,r,s,i);f!==i.distStyle&&o.push(`ALTER TABLE ${t} ALTER DISTSTYLE ${i.distStyle}`);let L=h(T)?.name,R=h(s)?.name;!L&&R?o.push(`ALTER TABLE ${t} ALTER DISTSTYLE KEY DISTKEY ${R}`):L&&!R?o.push(`ALTER TABLE ${t} ALTER DISTSTYLE AUTO`):L!==R&&o.push(`ALTER TABLE ${t} ALTER DISTKEY ${R}`);let Z=P(T),K=P(s),b=m.sortStyle,$=i.sortStyle;if(b===$&&!H(Z,K)||b!==$)switch($){case"INTERLEAVED":return A(e,r,s,i);case"COMPOUND":{let n=v(K);o.push(`ALTER TABLE ${t} ALTER ${$} SORTKEY(${n})`);break}case"AUTO":{o.push(`ALTER TABLE ${t} ALTER SORTKEY ${$}`);break}}let G=m.tableComment,C=i.tableComment;return G!==C&&o.push(`COMMENT ON TABLE ${t} IS ${C?`'${C}'`:"NULL"}`),await Promise.all(o.map(n=>l(n,i))),t}function v(t){return t.map(e=>e.name).join()}function ne(t){return t.encoding?` ENCODE ${t.encoding}`:""}var F=require("@aws-sdk/client-secrets-manager");var ie=new F.SecretsManager({});async function V(t,e){let r=t.username,s=t.passwordSecretArn,a=t;if(e.RequestType==="Create")return await D(r,s,a),{PhysicalResourceId:g(r,a,e.RequestId),Data:{username:r}};if(e.RequestType==="Delete"){await oe(r,a);return}else if(e.RequestType==="Update"){let{replace:i}=await me(r,s,a,e.OldResourceProperties);return{PhysicalResourceId:i?g(r,a,e.RequestId):e.PhysicalResourceId,Data:{username:r}}}else throw new Error(`Unrecognized event type: ${e.RequestType}`)}async function oe(t,e){await l(`DROP USER ${t}`,e)}async function D(t,e,r){let s=await N(e);await l(`CREATE USER ${t} PASSWORD '${s}'`,r)}async function me(t,e,r,s){let a=s;if(r.clusterName!==a.clusterName||r.databaseName!==a.databaseName)return await D(t,e,r),{replace:!0};let i=s.username,m=s.passwordSecretArn,o=await N(m),d=await N(e);return t!==i?(await D(t,e,r),{replace:!0}):d!==o?(await l(`ALTER USER ${t} PASSWORD '${d}'`,r),{replace:!1}):{replace:!1}}async function N(t){let r=(await ie.getSecretValue({SecretId:t})).SecretString;if(!r)throw new Error(`Secret string for ${t} was empty`);let{password:s}=JSON.parse(r);return s}var j={table:W,user:V,"user-table-privileges":B};async function ce(t){let e=j[t.ResourceProperties.handler];if(!e)throw new Error(`Requested handler ${t.ResourceProperties.handler} is not in supported set: ${JSON.stringify(Object.keys(j))}`);return e(t.ResourceProperties,t)}0&&(module.exports={handler});
